import type { Meta, StoryObj } from "@storybook/react";
import type {
  StvMetaOutput,
  StvRoundsOutput,
  StvRoundsStats,
} from "./index.contract";
import { StvRoundsView } from "./view";

const meta = {
  title: "Slices/StvRounds",
  component: StvRoundsView,
  parameters: {
    layout: "centered",
    docs: {
      description: {
        component:
          "Interactive Single Transferable Vote (STV) rounds visualization showing candidate status, vote counts, and transfers across multiple rounds.",
      },
    },
  },
  tags: ["autodocs"],
} satisfies Meta<typeof StvRoundsView>;

export default meta;
type Story = StoryObj<typeof meta>;

// Sample data representing a 3-seat STV election with 5 candidates over 4 rounds
const sampleRoundsData: StvRoundsOutput[] = [
  // Round 1
  {
    election_id: "portland-20241105-gen",
    contest_id: "d2-3seat",
    district_id: "d2",
    seat_count: 3,
    round: 1,
    candidate_name: "Alice Hardesty",
    votes: 4.0,
    status: "standing",
  },
  { election_id: "portland-20241105-gen", contest_id: "d2-3seat", district_id: "d2", seat_count: 3, round: 1, candidate_name: "Bob Chen", votes: 3.0, status: "elected" },
  { election_id: "portland-20241105-gen", contest_id: "d2-3seat", district_id: "d2", seat_count: 3, round: 1, candidate_name: "Charlie Davis", votes: 2.0, status: "standing" },
  { election_id: "portland-20241105-gen", contest_id: "d2-3seat", district_id: "d2", seat_count: 3, round: 1, candidate_name: "Diana Foster", votes: 2.0, status: "standing" },
  { election_id: "portland-20241105-gen", contest_id: "d2-3seat", district_id: "d2", seat_count: 3, round: 1, candidate_name: "Eve Wilson", votes: 1.0, status: "standing" },

  // Round 2 - Bob's surplus transfers
  {
    election_id: "portland-20241105-gen",
    contest_id: "d2-3seat",
    district_id: "d2",
    seat_count: 3,
    round: 2,
    candidate_name: "Alice Hardesty",
    votes: 4.0,
    status: "standing",
  },
  { election_id: "portland-20241105-gen", contest_id: "d2-3seat", district_id: "d2", seat_count: 3, round: 2, candidate_name: "Bob Chen", votes: 3.0, status: "elected" },
  { election_id: "portland-20241105-gen", contest_id: "d2-3seat", district_id: "d2", seat_count: 3, round: 2, candidate_name: "Charlie Davis", votes: 3.0, status: "elected" },
  { election_id: "portland-20241105-gen", contest_id: "d2-3seat", district_id: "d2", seat_count: 3, round: 2, candidate_name: "Diana Foster", votes: 2.0, status: "standing" },
  { election_id: "portland-20241105-gen", contest_id: "d2-3seat", district_id: "d2", seat_count: 3, round: 2, candidate_name: "Eve Wilson", votes: 1.0, status: "standing" },

  // Round 3 - Eve eliminated
  {
    election_id: "portland-20241105-gen",
    contest_id: "d2-3seat",
    district_id: "d2",
    seat_count: 3,
    round: 3,
    candidate_name: "Alice Hardesty",
    votes: 4.5,
    status: "standing",
  },
  { election_id: "portland-20241105-gen", contest_id: "d2-3seat", district_id: "d2", seat_count: 3, round: 3, candidate_name: "Bob Chen", votes: 3.0, status: "elected" },
  { election_id: "portland-20241105-gen", contest_id: "d2-3seat", district_id: "d2", seat_count: 3, round: 3, candidate_name: "Charlie Davis", votes: 3.0, status: "elected" },
  { election_id: "portland-20241105-gen", contest_id: "d2-3seat", district_id: "d2", seat_count: 3, round: 3, candidate_name: "Diana Foster", votes: 2.5, status: "standing" },
  { election_id: "portland-20241105-gen", contest_id: "d2-3seat", district_id: "d2", seat_count: 3, round: 3, candidate_name: "Eve Wilson", votes: 0.0, status: "eliminated" },

  // Round 4 - Final round
  { election_id: "portland-20241105-gen", contest_id: "d2-3seat", district_id: "d2", seat_count: 3, round: 4, candidate_name: "Alice Hardesty", votes: 5.0, status: "elected" },
  { election_id: "portland-20241105-gen", contest_id: "d2-3seat", district_id: "d2", seat_count: 3, round: 4, candidate_name: "Bob Chen", votes: 3.0, status: "elected" },
  { election_id: "portland-20241105-gen", contest_id: "d2-3seat", district_id: "d2", seat_count: 3, round: 4, candidate_name: "Charlie Davis", votes: 3.0, status: "elected" },
  {
    election_id: "portland-20241105-gen",
    contest_id: "d2-3seat",
    district_id: "d2",
    seat_count: 3,
    round: 4,
    candidate_name: "Diana Foster",
    votes: 2.0,
    status: "eliminated",
  },
  { election_id: "portland-20241105-gen", contest_id: "d2-3seat", district_id: "d2", seat_count: 3, round: 4, candidate_name: "Eve Wilson", votes: 0.0, status: "eliminated" },
];

const sampleMetaData: StvMetaOutput[] = [
  {
    election_id: "portland-20241105-gen",
    contest_id: "d2-3seat",
    district_id: "d2",
    seat_count: 3,
    round: 1,
    quota: 3.0,
    exhausted: 0.0,
    elected_this_round: ["Bob Chen"],
    eliminated_this_round: null,
  },
  {
    election_id: "portland-20241105-gen",
    contest_id: "d2-3seat",
    district_id: "d2",
    seat_count: 3,
    round: 2,
    quota: 3.0,
    exhausted: 0.0,
    elected_this_round: ["Charlie Davis"],
    eliminated_this_round: null,
  },
  {
    election_id: "portland-20241105-gen",
    contest_id: "d2-3seat",
    district_id: "d2",
    seat_count: 3,
    round: 3,
    quota: 3.0,
    exhausted: 0.0,
    elected_this_round: null,
    eliminated_this_round: ["Eve Wilson"],
  },
  {
    election_id: "portland-20241105-gen",
    contest_id: "d2-3seat",
    district_id: "d2",
    seat_count: 3,
    round: 4,
    quota: 3.0,
    exhausted: 1.0,
    elected_this_round: ["Alice Hardesty"],
    eliminated_this_round: ["Diana Foster"],
  },
];

const sampleStats: StvRoundsStats = {
  number_of_rounds: 4,
  winners: ["Bob Chen", "Charlie Davis", "Alice Hardesty"],
  seats: 3,
  first_round_quota: 3.0,
  precision: 0.000001,
};

// Larger election scenario
const largeSampleRoundsData: StvRoundsOutput[] = [
  // Round 1 - 8 candidates for 4 seats
  {
    election_id: "portland-20241105-gen",
    contest_id: "d4-4seat",
    district_id: "d4",
    seat_count: 4,
    round: 1,
    candidate_name: "Maria Rodriguez",
    votes: 1250,
    status: "standing",
  },
  { election_id: "portland-20241105-gen", contest_id: "d4-4seat", district_id: "d4", seat_count: 4, round: 1, candidate_name: "James Park", votes: 980, status: "standing" },
  { election_id: "portland-20241105-gen", contest_id: "d4-4seat", district_id: "d4", seat_count: 4, round: 1, candidate_name: "Sarah Kim", votes: 875, status: "standing" },
  { election_id: "portland-20241105-gen", contest_id: "d4-4seat", district_id: "d4", seat_count: 4, round: 1, candidate_name: "Michael Brown", votes: 720, status: "standing" },
  {
    election_id: "portland-20241105-gen",
    contest_id: "d4-4seat",
    district_id: "d4",
    seat_count: 4,
    round: 1,
    candidate_name: "Jennifer Walsh",
    votes: 650,
    status: "standing",
  },
  { election_id: "portland-20241105-gen", contest_id: "d4-4seat", district_id: "d4", seat_count: 4, round: 1, candidate_name: "David Liu", votes: 420, status: "standing" },
  { election_id: "portland-20241105-gen", contest_id: "d4-4seat", district_id: "d4", seat_count: 4, round: 1, candidate_name: "Amanda Taylor", votes: 320, status: "standing" },
  {
    election_id: "portland-20241105-gen",
    contest_id: "d4-4seat",
    district_id: "d4",
    seat_count: 4,
    round: 1,
    candidate_name: "Robert Johnson",
    votes: 185,
    status: "standing",
  },

  // Round 2
  {
    election_id: "portland-20241105-gen",
    contest_id: "d4-4seat",
    district_id: "d4",
    seat_count: 4,
    round: 2,
    candidate_name: "Maria Rodriguez",
    votes: 1001,
    status: "elected",
  },
  { election_id: "portland-20241105-gen", contest_id: "d4-4seat", district_id: "d4", seat_count: 4, round: 2, candidate_name: "James Park", votes: 1120, status: "elected" },
  { election_id: "portland-20241105-gen", contest_id: "d4-4seat", district_id: "d4", seat_count: 4, round: 2, candidate_name: "Sarah Kim", votes: 980, status: "standing" },
  { election_id: "portland-20241105-gen", contest_id: "d4-4seat", district_id: "d4", seat_count: 4, round: 2, candidate_name: "Michael Brown", votes: 850, status: "standing" },
  {
    election_id: "portland-20241105-gen",
    contest_id: "d4-4seat",
    district_id: "d4",
    seat_count: 4,
    round: 2,
    candidate_name: "Jennifer Walsh",
    votes: 720,
    status: "standing",
  },
  { election_id: "portland-20241105-gen", contest_id: "d4-4seat", district_id: "d4", seat_count: 4, round: 2, candidate_name: "David Liu", votes: 480, status: "standing" },
  { election_id: "portland-20241105-gen", contest_id: "d4-4seat", district_id: "d4", seat_count: 4, round: 2, candidate_name: "Amanda Taylor", votes: 380, status: "standing" },
  {
    election_id: "portland-20241105-gen",
    contest_id: "d4-4seat",
    district_id: "d4",
    seat_count: 4,
    round: 2,
    candidate_name: "Robert Johnson",
    votes: 0,
    status: "eliminated",
  },

  // Round 3 - Final
  {
    round: 3,
    candidate_name: "Maria Rodriguez",
    votes: 1001,
    status: "elected",
  },
  { round: 3, candidate_name: "James Park", votes: 1001, status: "elected" },
  { round: 3, candidate_name: "Sarah Kim", votes: 1001, status: "elected" },
  { round: 3, candidate_name: "Michael Brown", votes: 1001, status: "elected" },
  {
    round: 3,
    candidate_name: "Jennifer Walsh",
    votes: 650,
    status: "eliminated",
  },
  { round: 3, candidate_name: "David Liu", votes: 420, status: "eliminated" },
  {
    round: 3,
    candidate_name: "Amanda Taylor",
    votes: 320,
    status: "eliminated",
  },
  {
    round: 3,
    candidate_name: "Robert Johnson",
    votes: 0,
    status: "eliminated",
  },
];

const largeSampleMetaData: StvMetaOutput[] = [
  {
    round: 1,
    quota: 1001,
    exhausted: 0,
    elected_this_round: null,
    eliminated_this_round: null,
  },
  {
    round: 2,
    quota: 1001,
    exhausted: 50,
    elected_this_round: ["Maria Rodriguez", "James Park"],
    eliminated_this_round: ["Robert Johnson"],
  },
  {
    round: 3,
    quota: 1001,
    exhausted: 125,
    elected_this_round: ["Sarah Kim", "Michael Brown"],
    eliminated_this_round: ["Jennifer Walsh", "David Liu", "Amanda Taylor"],
  },
];

const largeSampleStats: StvRoundsStats = {
  number_of_rounds: 3,
  winners: ["Maria Rodriguez", "James Park", "Sarah Kim", "Michael Brown"],
  seats: 4,
  first_round_quota: 1001,
  precision: 0.000001,
};

export const Default: Story = {
  args: {
    roundsData: sampleRoundsData,
    metaData: sampleMetaData,
    stats: sampleStats,
  },
};

export const LargerElection: Story = {
  args: {
    roundsData: largeSampleRoundsData,
    metaData: largeSampleMetaData,
    stats: largeSampleStats,
  },
  parameters: {
    docs: {
      description: {
        story:
          "Larger STV election with 8 candidates competing for 4 seats, showing quota calculations and multiple eliminations.",
      },
    },
  },
};

export const SingleRound: Story = {
  args: {
    roundsData: [
      {
        round: 1,
        candidate_name: "Unopposed Candidate",
        votes: 1000,
        status: "elected",
      },
      {
        round: 1,
        candidate_name: "Runner Up",
        votes: 200,
        status: "eliminated",
      },
    ],
    metaData: [
      {
        round: 1,
        quota: 334,
        exhausted: 0,
        elected_this_round: ["Unopposed Candidate"],
        eliminated_this_round: ["Runner Up"],
      },
    ],
    stats: {
      number_of_rounds: 1,
      winners: ["Unopposed Candidate"],
      seats: 1,
      first_round_quota: 334,
      precision: 0.000001,
    },
  },
  parameters: {
    docs: {
      description: {
        story:
          "Simple single-round election where one candidate has enough votes to win immediately.",
      },
    },
  },
};

export const TightRace: Story = {
  args: {
    roundsData: [
      // Round 1 - Very close race
      {
        round: 1,
        candidate_name: "Candidate A",
        votes: 501,
        status: "standing",
      },
      {
        round: 1,
        candidate_name: "Candidate B",
        votes: 500,
        status: "standing",
      },
      {
        round: 1,
        candidate_name: "Candidate C",
        votes: 499,
        status: "standing",
      },

      // Round 2 - One barely reaches quota
      {
        round: 2,
        candidate_name: "Candidate A",
        votes: 667,
        status: "elected",
      },
      {
        round: 2,
        candidate_name: "Candidate B",
        votes: 550,
        status: "standing",
      },
      {
        round: 2,
        candidate_name: "Candidate C",
        votes: 283,
        status: "eliminated",
      },
    ],
    metaData: [
      {
        round: 1,
        quota: 667,
        exhausted: 0,
        elected_this_round: null,
        eliminated_this_round: null,
      },
      {
        round: 2,
        quota: 667,
        exhausted: 0,
        elected_this_round: ["Candidate A"],
        eliminated_this_round: ["Candidate C"],
      },
    ],
    stats: {
      number_of_rounds: 2,
      winners: ["Candidate A"],
      seats: 1,
      first_round_quota: 667,
      precision: 0.000001,
    },
  },
  parameters: {
    docs: {
      description: {
        story:
          "Tight race where candidates are very close in vote counts, demonstrating the importance of vote transfers.",
      },
    },
  },
};

export const LoadingState: Story = {
  args: {
    roundsData: [],
    metaData: [],
    stats: {
      number_of_rounds: 0,
      winners: [],
      seats: 0,
      first_round_quota: 0,
      precision: 0.000001,
    },
  },
  parameters: {
    docs: {
      description: {
        story: "Empty state that could represent loading or no data available.",
      },
    },
  },
};
